# FILE: docker-compose.yml
version: "3.8"

services:
  api:
    build:
      context: ./server
      dockerfile: Dockerfile
    environment:
      NODE_ENV: production
      PORT: 8787
    expose:
      - "8787"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:8787/health').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"]
      interval: 10s
      timeout: 3s
      retries: 5

  web:
    build:
      context: ./ui
      dockerfile: Dockerfile
      args:
        # Build-time env for Vite (used if your UI reads import.meta.env.VITE_API_BASE_URL)
        VITE_API_BASE_URL: /api
    ports:
      - "8080:80"
    depends_on:
      api:
        condition: service_healthy
    restart: unless-stopped

  kernel:
    build: .
    ports:
      - "8788:8787"
    volumes:
      - aegis_data:/opt/aegis-kernel/storage/sqlite
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:8787/health').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"]
      interval: 10s
      timeout: 3s
      retries: 5
    # Fulfills AXIOM_5_AWARENESS through logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"

volumes:
  aegis_data:
    driver: local
